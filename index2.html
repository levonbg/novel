<!DOCTYPE html>
<html class="theme-next mist use-motion">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <link href="app.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" id="hexo.configuration">
        var NexT = window.NexT || {};
        var CONFIG = {
            scheme: 'Mist',
            sidebar: { "position": "left", "display": "post" },
            fancybox: true,
            motion: true,
            duoshuo: {
                userId: undefined,
                author: 'levon'
            }
        };
    </script>
    <title> WebRTC 代码笔记 | levon's Blog </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" class="" style="padding-right: 0px;" lang="zh-Hans">
    <div class="container one-collumn sidebar-position-left page-post-detail ">
        <div class="headband"></div>
        <main id="main" class="main">
            <div class="main-inner">
                <div class="content-wrap">
                    <div id="content" class="content">
                        <div id="posts" class="posts-expand">
                            <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"
                                style="opacity: 1; display: block; transform: translateY(0px);">
                                <header class="post-header">
                                    <h1 class="post-title" itemprop="name headline">
                                        WebRTC 代码笔记
                                    </h1>
                                    <div class="post-meta">
                                        <span class="post-time">
                                            <span class="post-meta-item-icon">
                                                <i class="fa fa-calendar-o"></i>
                                            </span>
                                            <span class="post-meta-item-text">发表于</span>
                                            <time itemprop="dateCreated" datetime="2017-07-03T21:33:12+08:00"
                                                content="2017-07-03">
                                                2019-07-03
                                            </time>
                                        </span>
                                    </div>
                                </header>

                                <div class="post-body" itemprop="articleBody">
                            <div class="RichText ztext Post-RichText">
                               <p>
    http服务端发给我onId<br/>onCallReady 非空情况， 空的话，call(&quot;&quot;)&nbsp; -&gt; startCam();<br/>rtcactivity.answer 谁调用呢？<br/>&nbsp;&nbsp; &nbsp;webRtcClient.sendMessage(callerId, &quot;init&quot;, null);<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;httpClient.emit(&quot;message&quot;, message); 给服务端发了json报文<br/>&nbsp;&nbsp;&nbsp; startCam();<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;webRtcClient.start(&quot;android_test&quot;);<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;httpClient.emit(&quot;readyToStream&quot;, message);<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>call 谁来调用呢？<br/>&nbsp;&nbsp; &nbsp;startCam<br/>&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;<br/>服务端发送 message<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commandMap.put(&quot;init&quot;, new CreateOfferCommand());<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;创建offer 发invite<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commandMap.put(&quot;offer&quot;, new CreateAnswerCommand());<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;发200 ok<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commandMap.put(&quot;answer&quot;, new SetRemoteSDPCommand());<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;set sdp<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commandMap.put(&quot;candidate&quot;, new AddIceCandidateCommand());<br/>&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;tcpClient 的功能 sendMessage &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;DirectRTCClient 的4个功能<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;连接<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;connectToRoom<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;connectToRoomInternal<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;new了一个TCPChannelClient tcpClient<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;关闭连接<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;disconnectFromRoom<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;disconnectFromRoomInternal<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;tcpClient.disconnect();<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;tcpClient = null;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;收数据 <br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;onConnectedToRoom 不知道干嘛的<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;onTCPMessage 收json数据<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;candidate &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;onRemoteIceCandidate<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;remove-candidates&nbsp;&nbsp; &nbsp;onRemoteIceCandidatesRemoved<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;answer&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;onRemoteDescription<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;offer&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;onConnectedToRoom<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;发数据<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sendOfferSdp type offer<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sendAnswerSdp type answer<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sendLocalIceCandidate type candidate<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sendLocalIceCandidateRemovals type remove-candidates<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sendMessage 发送json<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/><br/><br/><br/>
</p><p>
    <br/>AudioTrackInterface 这个接口提供哪些方法<br/>CreateAudioTrack 返回类型是什么，如何实现刚才接口的方法 PeerConnectionFactory::CreateAudioTrack<br/>&nbsp;&nbsp; &nbsp;AudioTrack::Create&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;没啥用<br/>&nbsp;&nbsp; &nbsp;AudioTrackProxy::Create<br/>CreateAudioSource 这个干嘛的&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;工厂的<br/>&nbsp;&nbsp; &nbsp;LocalAudioSource::Create<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;source-&gt;Initialize(audio_options);<br/>AddTrack 干嘛的 连接的<br/><br/>PostSetSessionDescriptionSuccess<br/>MSG_SET_SESSIONDESCRIPTION_SUCCESS<br/>Conductor::OnSuccess<br/>SetLocalDescription<br/>RTCError PeerConnection::ApplyLocalDescription(<br/>VideoTrackInterface的api有两个：AddOrUpdateSink添加回调，和OnFrame回调处理<br/><br/>UpdateRemoteSendersList<br/>void PeerConnection::OnRemoteSenderAdded(const RtpSenderInfo&amp; sender_info,<br/>CreateAudioReceiver<br/>OnAddTrack放到队列里<br/>UI线程收到 NEW_TRACK_ADDED ，设置track回调<br/><br/><br/>CreateVoiceChannel<br/>&nbsp;&nbsp; &nbsp;VoiceChannel* ChannelManager::CreateVoiceChannel(<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;VoiceMediaChannel* WebRtcVoiceEngine::CreateChannel(<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;WebRtcVoiceMediaChannel::WebRtcVoiceMediaChannel(<br/>CreateVideoChannel<br/>CreateDataChannel<br/><br/><br/>peer_connection_-&gt;SetRemoteDescription(<br/>peer_connection_-&gt;CreateAnswer(<br/><br/><br/>GetCodecsForAnswer协商核心<br/>&nbsp;&nbsp; &nbsp;AddAudioContentForAnswer<br/><br/><br/>void Conductor::ConnectToPeer(int peer_id)&nbsp; examples\peerconnection\client\conductor.cc&nbsp;&nbsp; 发起呼叫peer_id<br/>&nbsp;&nbsp; &nbsp;InitializePeerConnection<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;CreatePeerConnection<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;peer_connection_ = peer_connection_factory_-&gt;CreatePeerConnection(&nbsp; config, nullptr, nullptr, this);<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;PeerConnectionProxy::Create(signaling_thread(), pc);<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AddTracks<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;peer_connection_factory_-&gt;CreateAudioSource<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;peer_connection_-&gt;AddTrack<br/>&nbsp;&nbsp; &nbsp;peer_connection_-&gt;CreateOffer( this, webrtc::PeerConnectionInterface::RTCOfferAnswerOptions());<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;void PeerConnection::CreateOffer(CreateSessionDescriptionObserver* observer,&nbsp;&nbsp;&nbsp; const RTCOfferAnswerOptions&amp; options) <br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;void WebRtcSessionDescriptionFactory::CreateOffer(&nbsp;&nbsp;&nbsp; CreateSessionDescriptionObserver* observer,&nbsp;&nbsp;&nbsp; const PeerConnectionInterface::RTCOfferAnswerOptions&amp; options,&nbsp;&nbsp;&nbsp; const cricket::MediaSessionOptions&amp; session_options) <br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;InternalCreateOffer<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;PostCreateSessionDescriptionSucceeded<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;MSG_CREATE_SESSIONDESCRIPTION_SUCCESS 放到一个队列里<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;队列处理OnSuccess 指向了void Conductor::OnSuccess(webrtc::SessionDescriptionInterface* desc) <br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SendMessage 发送消息到SEND_MESSAGE_TO_PEER队列<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;队列处理if (!client_-&gt;SendToPeer(peer_id_, *msg) &amp;&amp; peer_id_ != -1) <br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;发了一条http请求<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;void Conductor::OnMessageFromPeer(int peer_id, const std::string&amp; message)&nbsp; 收到应答报文<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;peer_connection_-&gt;SetRemoteDescription(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DummySetSessionDescriptionObserver::Create(),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session_description.release());<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ApplyRemoteDescription 复杂的很！！！！<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;PushdownTransportDescription<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;UpdateTransceiversAndDataChannels<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;CreateChannels<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;UpdateSessionState<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;MediaStreamProxy::Create<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;remote_streams_-&gt;AddStream(stream);<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;observer-&gt;OnSetRemoteDescriptionComplete(RTCError::OK());<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;pc_-&gt;PostSetSessionDescriptionSuccess(wrapper_);发送MSG_SET_SESSIONDESCRIPTION_SUCCESS 消息到队列<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;队列处理param-&gt;observer-&gt;OnSuccess();<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;CreatePeerConnectionFactory&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>examples\peerconnection\client\conductor.cc 所有代码从这里读起<br/><br/><br/>modules\audio_processing 从这里开始读起<br/>AudioBuffer 这个是buffer&nbsp; 谁new呢？什么时候new呢？<br/>int AudioProcessingImpl::InitializeLocked() { 会new 两份 一个是收音 一个是放音<br/>AudioProcessingBuilder::Create&nbsp; 会new一个AudioProcessingImpl<br/><br/><br/>CreatePeerConnectionFactory&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;demo<br/>&nbsp;&nbsp; &nbsp;cricket::WebRtcMediaEngineFactory::Create<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;webrtc::AudioProcessingBuilder().Create()<br/><br/>USE_BUILTIN_SW_CODECS&nbsp;&nbsp; 默认禁用，别管它<br/>&nbsp;&nbsp; &nbsp;WebRtcMediaEngineFactory::Create(<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;webrtc::AudioProcessingBuilder().Create());<br/><br/>OrtcFactory::CreateMediaEngine_w() {&nbsp;&nbsp; ortc是什么？ webrtc2.0<br/>&nbsp;&nbsp; &nbsp;webrtc::AudioProcessingBuilder().Create()));<br/><br/>rtc::scoped_refptr&lt;PeerConnectionFactoryInterface&gt; CreatePeerConnectionFactory(<br/><br/><br/><br/><br/>WEBRTC_NS_FLOAT / WEBRTC_NS_FIXED&nbsp; 区别是什么？不重要<br/><br/><br/><br/>自己的应用程序调用webrtc::CreatePeerConnectionFactory得到一个工厂<br/>&nbsp;&nbsp; &nbsp;cricket::WebRtcMediaEngineFactory::Create&nbsp; 重点 <br/>&nbsp;&nbsp; &nbsp;CreateCallFactory<br/>&nbsp;&nbsp; &nbsp;CreateRtcEventLogFactory<br/>&nbsp;&nbsp; &nbsp;CreateModularPeerConnectionFactory<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;new了一个PeerConnectionFactory 重点 signaling_thread<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>AudioRtpReceiver 谁来收？<br/><br/>PeerConnection::CreateReceiver 根据媒体类型，来new一个AudioRtpReceiver/VideoRtpReceiver<br/>&nbsp;&nbsp; &nbsp;PeerConnection::AddTrackUnifiedPlan<br/>&nbsp;&nbsp; &nbsp;PeerConnection::AddTransceiver<br/>&nbsp;&nbsp; &nbsp;PeerConnection::AssociateTransceiver<br/>PeerConnection::CreateAudioReceiver 和上面同级<br/>&nbsp;&nbsp; &nbsp;PeerConnection::OnRemoteSenderAdded<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;void PeerConnection::UpdateRemoteSendersList(<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ApplyRemoteDescription&nbsp;&nbsp;&nbsp; 重点<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>NoiseSuppressionImpl&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; 构造<br/>ProcessCaptureAudio<br/>&nbsp;&nbsp; &nbsp;ProcessCaptureStreamLocked<br/>&nbsp;&nbsp; &nbsp;{<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AudioBuffer* capture_buffer = capture_.capture_audio.get();&nbsp; // For brevity.<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;private_submodules_ 有哪些？<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;public_submodules_&nbsp;&nbsp; 有哪些？<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;调用对应的音频处理api<br/>&nbsp;&nbsp; &nbsp;}<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AudioProcessingImpl::ProcessStream<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProcessCaptureFrame<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;int32_t AudioTransportImpl::RecordedDataIsAvailable(<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;处理本地音频数据<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;发送音频数据SendAudioData<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ADMWrapper::RecordedDataIsAvailable<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AudioDeviceBuffer::DeliverRecordedData() <br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FineAudioBuffer::DeliverRecordedData<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AudioDeviceLinuxPulse::ProcessRecordedData<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ReadRecordedData<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;RecThreadProcess<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;RecThreadFunc<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AudioDeviceLinuxPulse::Init() 创建了两个线程，一个收音（会对音频处理）一个放音<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AudioDeviceModuleImpl::Init()&nbsp; 其中 AudioDeviceModuleImpl::CreatePlatformSpecificObjects() {创建了音频设备对象<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;WebRtcVoiceEngine::Init() 创建了AudioDeviceModule 调用了create和init<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;webrtc::CreatePeerConnectionFactory( 工厂里做的<br/><br/>NoiseEstimate<br/>&nbsp;&nbsp; &nbsp;AudioProcessingImpl 构造的时候可以指定自己的处理器函数<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ProcessCaptureStreamLocked 先执行 public里的process，再执行自定义的process<br/><br/>CreateAudioReceiveStream<br/>&nbsp;&nbsp; &nbsp;AudioReceiveStream 调用start 启动线程<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;channel_proxy_-&gt;StartPlayout();<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;int error = channel_-&gt;StartPlayout();<br/>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;int32_t OnReceivedPayloadData(const uint8_t* payloadData, 收到数据调用 if (audio_coding_-&gt;IncomingPacket(payloadData, payloadSize, *rtpHeader) != acm模块处理<br/>&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br/>int32_t RTPReceiverAudio::ParseAudioCodecSpecific(&nbsp; 通道channel包含两个rtp，一个收一个发<br/>RTPReceiverAudio::ParseRtpPacket<br/>bool RtpReceiverImpl::IncomingRtpPacket<br/>bool Channel::ReceivePacket(const uint8_t* packet,&nbsp; 调用一次&nbsp; 收到一个包，回调&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Channel::OnReceivedPayloadData<br/>OnRtpPacket<br/><br/><br/><br/>AsyncUDPSocket::OnReadEvent(AsyncSocket* socket) { 谁来调用呢？&nbsp;&nbsp; 这个功能是收udp数据<br/><br/><br/>AllocationSequence UDP创建 ，收数据接口是AllocationSequence::OnReadPacket<br/>&nbsp;&nbsp; &nbsp;Port::HandleIncomingPacket(rtc::AsyncPacketSocket* socket, 来收数据<br/><br/>
</p>
                            </div>
                                </div>
                                <footer class="post-footer">
                                    <div class="post-nav">
                                        <div class="post-nav-next post-nav-item"> <a href="index1.html" rel="next"> 上一篇
                                            </a> </div>
                                        <div class="post-nav-prev post-nav-item"> <a href="index3.html" rel="prev"> 下一篇
                                            </a> </div>
                                    </div>
                                </footer>
                            </article>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer id="footer" class="footer">
            <div class="footer-inner">
                <div class="copyright">

                    © 2019 -
                    <span itemprop="copyrightYear">2019</span>
                    <span class="author" itemprop="copyrightHolder">Levon</span>
                </div>
                <div class="powered-by">
                    由 <a class="theme-link" href="http://hexo.io/">Hexo</a> 强力驱动
                </div>
                <div class="theme-info">
                    主题 -
                    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
                        NexT.Mist
                    </a>
                </div>
            </div>
        </footer>
        <div class="back-to-top back-to-top-on">
            <svg class="Zi Zi--BackToTop" title="回到顶部" fill="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path
                    d="M16.036 19.59a1 1 0 0 1-.997.995H9.032a.996.996 0 0 1-.997-.996v-7.005H5.03c-1.1 0-1.36-.633-.578-1.416L11.33 4.29a1.003 1.003 0 0 1 1.412 0l6.878 6.88c.782.78.523 1.415-.58 1.415h-3.004v7.005z">
                </path>
            </svg>
        </div>
    </div>
    <script type="text/javascript" src="index.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="velocity.js"></script>
    <script type="text/javascript" src="velocity_002.js"></script>
    <script type="text/javascript" src="jquery_002.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="motion.js"></script>
    <script type="text/javascript" src="scrollspy.js"></script>
    <script type="text/javascript" src="bootstrap.js"></script>
</body>

</html>
